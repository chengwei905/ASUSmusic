<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é€²éšŽéŸ³æ¨‚æ’­æ”¾å™¨</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f9f9f9; }
    h1, h2, h3 { margin-top: 1em; }
    #playlist div { cursor: pointer; padding: 5px; margin: 2px 0; background: #eee; border-radius: 4px; }
    #playlist div:hover { background: #ddd; }
    #playlist .playing { background: #cce5ff; font-weight: bold; }
    #loading { font-style: italic; color: #666; }
    #debug { margin-top: 2em; background: #fffbe6; padding: 1em; border: 1px solid #ccc; border-radius: 6px; }
    #debug ul { padding-left: 1.2em; }
    #search { margin-top: 1em; padding: 5px; width: 100%; box-sizing: border-box; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.5/dist/jsmediatags.min.js"></script>
</head>
<body>
  <h1>ðŸŽµ é€²éšŽéŸ³æ¨‚æ’­æ”¾å™¨</h1>
  <audio controls></audio>
  <div id="loading">æ­£åœ¨è¼‰å…¥éŸ³æ¨‚æ¸…å–®...</div>

  <input type="text" id="search" placeholder="ðŸ” æœå°‹æ­Œæ›²..." />

  <h2>æ’­æ”¾æ¸…å–®</h2>
  <div id="playlist"></div>

  <div id="debug">
    <h3>é™¤éŒ¯è³‡è¨Š</h3>
    <p><strong>éŸ³è¨Šè³‡æ–™å¤¾ï¼š</strong> <span id="music-path"></span></p>
    <p><strong>è¼‰å…¥ç‹€æ…‹ï¼š</strong> <span id="load-status"></span></p>
    <p><strong>è¼‰å…¥çš„æª”æ¡ˆï¼š</strong></p>
    <ul id="loaded-files"></ul>
  </div>

  <script>
    const getMusicBase = () => {
      const basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
      return basePath + 'music/';
    };

    const fetchPlaylistJson = async (base) => {
      try {
        const res = await fetch(`${base}playlist.json`);
        if (!res.ok) throw new Error('playlist.json not found');
        return await res.json();
      } catch (err) {
        return null;
      }
    };

    const fetchM3U = async (base) => {
      try {
        const res = await fetch(`${base}playlist.m3u`);
        const text = await res.text();
        return text
          .split('\n')
          .map(line => line.trim())
          .filter(line => line && !line.startsWith('#'))
          .map(file => base + file);
      } catch (err) {
        return null;
      }
    };

    const fetchAutoIndex = async (base) => {
      try {
        const res = await fetch(base);
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        return [...doc.querySelectorAll('a')]
          .map(a => a.getAttribute('href'))
          .filter(href => href && href.endsWith('.mp3'))
          .map(href => base + href);
      } catch (err) {
        return [];
      }
    };

    const loadPlaylist = async () => {
      const base = getMusicBase();
      const m3uList = await fetchM3U(base);
      if (m3uList && m3uList.length) return m3uList;

      const jsonList = await fetchPlaylistJson(base);
      if (jsonList && jsonList.length) return jsonList.map(file => base + file);

      const autoList = await fetchAutoIndex(base);
      if (autoList.length) return autoList;

      return [];
    };

    const renderPlaylistUI = (list, currentUrl) => {
      const container = document.getElementById('playlist');
      container.innerHTML = '';
      list.forEach((url, i) => {
        const item = document.createElement('div');
        item.textContent = url.split('/').pop();
        if (url === currentUrl) item.classList.add('playing');

        jsmediatags.read(url, {
          onSuccess: ({ tags }) => {
            const title = tags.title || url.split('/').pop();
            const artist = tags.artist || '';
            item.textContent = artist ? `${artist} - ${title}` : title;
          },
          onError: () => {}
        });

        item.onclick = () => {
          const audio = document.querySelector('audio');
          audio.src = url;
          audio.play();
          localStorage.setItem('lastPlayed', url);
          renderPlaylistUI(list, url);
        };
        container.appendChild(item);
      });
    };

    const updateDebugInfo = (base, playlist) => {
      document.getElementById('music-path').textContent = base;
      document.getElementById('load-status').textContent = playlist.length
        ? 'âœ… æˆåŠŸè¼‰å…¥'
        : 'âŒ æ‰¾ä¸åˆ°éŸ³è¨Šæª”æ¡ˆ';

      const list = document.getElementById('loaded-files');
      list.innerHTML = '';
      playlist.forEach(url => {
        const li = document.createElement('li');
        li.textContent = url;
        list.appendChild(li);
      });
    };

    let fullPlaylist = [];

    const initPlayer = async () => {
      const base = getMusicBase();
      const playlist = await loadPlaylist();
      fullPlaylist = playlist;
      document.getElementById('loading').style.display = 'none';

      updateDebugInfo(base, playlist);

      if (!playlist.length) {
        alert('æ‰¾ä¸åˆ°é è¨­éŸ³æ¨‚ï¼Œè«‹ç¢ºèª music è³‡æ–™å¤¾æ˜¯å¦å­˜åœ¨éŸ³è¨Šæª”æ¡ˆ');
        return;
      }

      const audio = document.querySelector('audio');
      const lastPlayed = localStorage.getItem('lastPlayed');
      const defaultTrack = playlist.includes(lastPlayed) ? lastPlayed : playlist[0];

      audio.src = defaultTrack;
      audio.play().catch(() => console.log('Autoplay blocked'));

      renderPlaylistUI(playlist, defaultTrack);

      audio.addEventListener('ended', () => {
        const currentIndex = playlist.indexOf(audio.src);
        const nextIndex = (currentIndex + 1) % playlist.length;
        const nextTrack = playlist[nextIndex];
        audio.src = nextTrack;
        audio.play();
        localStorage.setItem('lastPlayed', nextTrack);
        renderPlaylistUI(playlist, nextTrack);
      });

      document.getElementById('search').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = fullPlaylist.filter(url => url.toLowerCase().includes(keyword));
        renderPlaylistUI(filtered, audio.src);
      });
    };

    initPlayer();
  </script>
</body>
</html>

